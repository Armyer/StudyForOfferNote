## 优化MySQL

### 数据库命名规范

* 所有数据库对象名称使用小写字母并用下划线分割
* 所有数据库对象名称禁止使用MySQL保留关键字（如果表名包含关键字查询时，需要将其用单括号括起来）
* 数据库对象的命名要做到见名知意，并且最好不要超过32个字符
* 临时表必须以tmp_为前缀并以日期为后缀。备份表必须以bak_为前缀并以日期为后缀
* 所有存储相同数据的列名和列类型必须一致（如果不一致，会自动进行数据类型隐式转换，会造成列上的索引失效，导致查询效率降低）

### 数据基本设计规范

1. **所有表必须使用Innodb存储引擎**：该引擎支持事务、支持行级锁，更好的恢复性，高并发下性能更好。
2. **数据库和表的字符集统一使用UTF-8**：兼容性更好，避免乱码。如果有存储emoji表情的需要，字符集需要采用utf8mb4字符集。
3. **所有表和字段都需要添加注释**：使用comment从句添加表和列的备注，从一开始就进行数据字典的维护。
4. **尽量控制单表数据量的大小，建议控制在500万以内**：该数字不是MySQL数据库的限制，而是过大会造成修改表结构，备份，恢复都会有很大的问题。可以用**历史数据归档**（应用于日志数据），**分库分表**（应用于业务数据）等手段来控制数据量的大小。
5. **谨慎使用MySQL分区表**：分区表在物理上表现为多个文件，在逻辑上表现为一个表。因而实际跨分区查询效率可能会更低，建议采用物理分表的方式管理大数据。
6. **尽量做到冷热数据分离，减小表的宽度**。MySQL限制每个表最多存储4096列，并且每一行数据的大小不能超过65535字节。
7. **禁止在表中建立预留字段**：比较难做到见名识义。无法确认存储的数据类型。
8. **禁止在数据库中存储图片，文件等大的二进制数据**：IO操作很耗时，通常存储与文件服务器，数据库只存储文件地址信息。
9. 禁止在线上做数据库压力测试
10. 禁止从开发环境，测试环境直接连接生成环境数据库


### 数据库字段设计规范

1. 优先选择符合存储需要的最小的数据类型：列的字段越大，建立索引时所需要的空间也就越大，这样一页中所能存储的索引节点的数量也就越少，遍历时所需要的IO次数也就越多，索引的性能也就越差。
2. 避免使用text,blob数据类型，最常见的text类型可以存储64k的数据
3. 避免使用enum类型
4. 尽可能把所有列定义为not null：索引null列需要额外的空间来保存，所以要占用更多的空间，进行比较和计算时要对null值做特别的处理
5. 使用timestamp(4个字节)或datatime类型(8个字节）存储时间
6. 同财务相关的金额类数据必须使用decimal类型：非精准浮点（float,double), 精准浮点（decimal)


### 数据库操作行为规范
1. 超过100万行的批量写update，delete，insert等操作，要分批多次进行操作
2. 对于大表使用pt-online-schema-change修改表结构：pt-online-schema-change 它会首先建立一个与原表结构相同的新表，并且在新表上进行表结构的修改，然后再把原表中的数据复制到新表中，并在原表中增加一些触发器。把原表中新增的数据也复制到新表中，在行所有数据复制完成之后，把新表命名成原表，并把原来的表删除掉。把原来一个 DDL 操作，分解成多个小的批次进行。
3. 禁止为程序使用的账号赋予super权限
4. 对于程序连接数据库账号，遵循权限最小原则：
* 程序使用数据库账号只能在一个DB下使用，不准跨库
* 程序使用的账号原则上不准有drop权限


### 索引设计规范
1. 限制每张表上的索引数量，建议单张表索引不超过5个
2. 禁止在表中的每一列都建立单独的索引
3. 每个Innodb表必须有个主键
4. 常见索引列建议
* 出现在select, update, delete语句的where从句中的列
* 包含在order by, group by, distinct中的字段
* 并不要将符合1和2的字段的列都建立一个索引，通常将1，2中的字段建立联合索引效果会更好
* 多表join的关联列
5. 如何选择索引列的顺序：
索引目的：系统通过索引进行数据查找，减少随机IO，增加查询性能，索引能过滤出较少的数据，则从磁盘中读入的数据也就越少。
* 区分度最高的放在联合索引的最左侧（区分度=列中不同值的数量/列的总行数）
* 尽量把字段长度小的列放在联合索引的最左侧
* 使用最频繁的列放在联合索引的左侧

6. 避免建立冗余所以和重复索引
7. 对于频繁的查询优先考虑使用覆盖索引：就是包含了所有查询字段（where , select, order by, group by）的索引

8. 索引SET规范：尽量避免使用外键约束

### 数据库SQL开发规范
1. 建议使用预编译语句进行数据库操作
2. 避免数据类型的隐式转换
3. 充分利用表上已经存在的索引
4. 数据库设计时，应该要对以后扩展进行考虑
5. 程序连接不同的数据库使用不同的账号，禁止跨库查询
6. 禁止使用select * 必须使用select <字段列表>查询
7. 禁止使用不含字段列表的insert语句
8. 避免使用子查询，可以把子查询优化为join操作
9. 避免使用join关联太多的表
10. 减少同数据库的交互次数
11. 对应同一列进行or判断时，使用in代替or
12. 禁止使用order by rand()进行随机排序
13. where从句中禁止对列进行函数转换和计算
14. 在明显不会有重复值时使用union all而不是union
15. 拆分复杂的大SQL为多个小sql


#### 总结：数据库的目的，本质就是一个存储数据的玩意。因而更快更好的给出所需要的数据是第一准则。为了达到这个目的，则需要一开始从设计数据库时就要考虑很多地方，并且为了更快获得数据，引入了索引等工具，类似于字典的目录一样的功能。但是过犹不及，大量的使用索引不一定就能达到最优。万事讲究一个平衡！以及后续sql语句的使用，总的来说，就是要准确，简洁的表达使用。如果不规范，造成的后果大致就是获得数据要更慢，而这个慢体现在很多地方，比如IO会慢，索引会慢，加了锁慢，需要数据类型转换慢等等各种各样的慢，甚至严重会导致程序奔溃，因而合理设计数据库表，规范使用SQL，使用分而治之的思想方可实现优美的MySQL。